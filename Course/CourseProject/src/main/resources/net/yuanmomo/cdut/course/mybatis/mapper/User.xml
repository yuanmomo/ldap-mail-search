<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="net.yuanmomo.cudt.course.web.dao.mapper.User">
	<delete id="doDelete" parameterType="int">
		UPDATE USERTABLE SET ISDELETED='1' WHERE USERID =#{id}
	</delete>
	<insert id="doInsertAStu" parameterType="User"
		useGeneratedKeys="true" keyProperty="UserId">
		INSERT INTO USERTABLE(USERNAME,
		PASSWORD,PHONE,EMAIL,ROLE,REGTIME,REGIP,LASTLOGINTIME,
		LASTLOGINIP,STUNUMBER,STUCLASSID,STUCOURSEID ,
		STUTEACHERID)
		VALUES(#{userName},#{password},#{phone},#{email},3,#{regTime},
		#{regIp},#{lastLoginTime},#{lastLoginIp},#{stuNumber},#{stuClassId},
		 #{stuCourseId},#{stuTeacherId})
	</insert>
	<insert id="doInsertATea" parameterType="User"
		useGeneratedKeys="true" keyProperty="UserId">
		INSERT INTO USERTABLE (USERNAME,PASSWORD,PHONE,EMAIL,
		ROLE,REGTIME,REGIP,LASTLOGINTIME,LASTLOGINIP,TEAPOSITION,
		TEADESCRIPTION,TEAMAXSTU)
		VALUES (#{userName},#{password},#{phone},#{email},2,#{regTime},
		#{regIp},#{lastLoginTime},#{lastLoginIp},#{teaPosition},#{teaDescription},#{teaMaxStu})
	</insert>
	<update id="doUpdate" parameterType="User">
		UPDATE USERTABLE SET USERNAME =#{userName},
		PASSWORD=#{password},PHONE= #{phone},EMAIL=#{email},ROLE=#{role},
		LASTLOGINTIME = #{lastLoginTime},LASTLOGINIP =  #{lastLoginIp},
		TEAPOSITION=#{teaPosition},TEADESCRIPTION =#{teaDescription},
		TEAMAXSTU=#{teaMaxStu},TEACURRENTSTU = #{teaCurrentStu},
		STUCLASSID =#{stuClassId},STUCOURSEID =  #{stuCourseId},
		STUTEACHERID = #{stuTeacherId} 
		WHERE USERID =#{userId} AND ISDELETED='0'
	</update>
	<select id="isStuNumberExist" resultType="int" parameterType="String">
		SELECT COUNT(*) FROM USERTABLE WHERE ISDELETED='0' AND STUNUMBER=#{stuNumber}
	</select>
	<select id="getTeachersCount" resultType="int">
		SELECT COUNT(*) FROM USERTABLE WHERE ISDELETED=0 AND ROLE=2
	</select>
	<select id="getStudentsCount" resultType="int">
		SELECT COUNT(*) FROM USERTABLE WHERE ISDELETED=0 AND ROLE=3
	</select>
	<select id="getUserByLogin" resultType="User" parameterType="UserLoginEntity" >
		SELECT USERID,USERNAME,PASSWORD,PHONE,EMAIL,ROLE,
		REGTIME,REGIP,LASTLOGINTIME,LASTLOGINIP,TEAPOSITION,
		TEADESCRIPTION,TEAMAXSTU,TEACURRENTSTU,STUNUMBER,
		STUCLASSID,STUCOURSEID,STUTEACHERID
		FROM  USERTABLE WHERE ISDELETED=0 AND 
		 (USERNAME=#{userName} OR STUNUMBER=#{stuNumber}) AND PASSWORD=#{password} 
	</select>
	<select id="getUserById" resultType="User" parameterType="int" >
		SELECT USERID,USERNAME,PASSWORD,PHONE,EMAIL,ROLE,
		REGTIME,REGIP,LASTLOGINTIME,LASTLOGINIP,TEAPOSITION,
		TEADESCRIPTION,TEAMAXSTU,TEACURRENTSTU,STUNUMBER,
		STUCLASSID,STUCOURSEID,STUTEACHERID,ISDELETED
		FROM  USERTABLE WHERE ISDELETED=0 AND 
		USERID=#{id} 
	</select>
	<select id="getStudentsWithClass" resultType="Student">
		SELECT A1.USERID, A1.USERNAME, A1.PASSWORD, A1.PHONE, A1.EMAIL,
		A1.ROLE, A1.REGTIME, A1.REGIP, A1.LASTLOGINTIME, A1.LASTLOGINIP,
		A1.STUNUMBER, A1.STUCLASSID, A1.STUCOURSEID, A1.STUTEACHERID,
		A2.CLASSNAMENUMBER AS 'classNameNum', A2.CLASSNAMECHI AS
		'classNameChi', A1.ISDELETED, A3.USERNAME AS 'teacherName'
		FROM USERTABLE A1, CLASSTABLE A2,USERTABLE A3
		WHERE A1.ISDELETED =0 AND A1.STUTEACHERID=A3.USERID
		AND A1.ROLE =3
		AND A1.STUCLASSID = A2.CLASSID 
		ORDER BY STUNUMBER
	</select>
	<select id="getStudentDetailById" resultType="Student" parameterType="int">
		SELECT A1.USERID, A1.USERNAME, A1.PASSWORD, A1.PHONE, A1.EMAIL,
		A1.ROLE, A1.REGTIME, A1.REGIP, A1.LASTLOGINTIME, A1.LASTLOGINIP,
		A1.STUNUMBER, A1.STUCLASSID, A1.STUCOURSEID, A1.STUTEACHERID,
		A2.CLASSNAMENUMBER AS 'classNameNum', A2.CLASSNAMECHI AS
		'classNameChi', A1.ISDELETED,A3.USERNAME AS 'teacherName',A4.COURSE_NAME AS 'courseName'
		FROM USERTABLE A1,CLASSTABLE A2,USERTABLE A3,COURSETABLE A4
		WHERE A1.ISDELETED =0
		AND A1.STUCLASSID = A2.CLASSID AND A1.STUTEACHERID=A3.USERID 
		AND A1.STUCOURSEID = A4.COURSE_ID AND A1.USERID=#{id}
		ORDER BY STUNUMBER
	</select>
	<select id="getTeachers" resultType="TeaPosi">
		SELECT A1.USERID,A1.USERNAME,A1.PASSWORD,A1.PHONE,A1.EMAIL,A1.ROLE,
		A1.REGTIME,A1.REGIP,A1.LASTLOGINTIME,A1.LASTLOGINIP,A1.TEAPOSITION,A2.POSITION_NAME,
		A1.TEADESCRIPTION,A1.TEAMAXSTU,A1.TEACURRENTSTU,
		A1.ISDELETED FROM USERTABLE A1,POSITIONTABLE A2 WHERE A1.ISDELETED=0 AND 
		A1.ROLE=2 AND A1.TEAPOSITION=A2.POSITION_ID
	</select>
	<select id="isTeaNameExist" resultType="User" parameterType="String" >
		SELECT USERID,USERNAME,PASSWORD,PHONE,EMAIL,ROLE,
		REGTIME,REGIP,LASTLOGINTIME,LASTLOGINIP,TEAPOSITION,
		TEADESCRIPTION,TEAMAXSTU,TEACURRENTSTU,STUNUMBER,
		STUCLASSID,STUCOURSEID,STUTEACHERID,ISDELETED
		FROM  USERTABLE WHERE ISDELETED=0 AND USERNAME=#{userName}
	</select>
	<select id="getStudentByStuNumber" resultType="User" parameterType="String" >
		SELECT USERID,USERNAME,PASSWORD,PHONE,EMAIL,ROLE,
		REGTIME,REGIP,LASTLOGINTIME,LASTLOGINIP,TEAPOSITION,
		TEADESCRIPTION,TEAMAXSTU,TEACURRENTSTU,STUNUMBER,
		STUCLASSID,STUCOURSEID,STUTEACHERID,ISDELETED
		FROM  USERTABLE WHERE ISDELETED=0 AND STUNUMBER=#{stuNumber}
	</select>
	<select id="getTeacherPositionById" resultType="TeaPosi" parameterType="int">
		SELECT A1.USERID,A1.USERNAME,A1.PASSWORD,A1.PHONE,A1.EMAIL,A1.ROLE,
		A1.REGTIME,A1.REGIP,A1.LASTLOGINTIME,A1.LASTLOGINIP,A1.TEAPOSITION,A2.POSITION_NAME,
		A1.TEADESCRIPTION,A1.TEAMAXSTU,A1.TEACURRENTSTU,
		A1.ISDELETED FROM USERTABLE A1,POSITIONTABLE A2 WHERE A1.ISDELETED=0 AND 
		A1.USERID=#{id} AND A1.TEAPOSITION=A2.POSITION_ID
	</select>
	<select id="getStudentDetailByTeacherId" resultType="Student" parameterType="int">
		SELECT A1.USERID, A1.USERNAME, A1.PASSWORD, A1.PHONE, A1.EMAIL,
		A1.ROLE, A1.REGTIME, A1.REGIP, A1.LASTLOGINTIME, A1.LASTLOGINIP,
		A1.STUNUMBER, A1.STUCLASSID, A1.STUCOURSEID, A1.STUTEACHERID,
		A2.CLASSNAMENUMBER AS 'classNameNum', A2.CLASSNAMECHI AS
		'classNameChi', A1.ISDELETED,A3.USERNAME AS 'teacherName',
		A4.COURSE_NAME AS 'courseName',A4.COURSE_ID AS 'stuCourseId',
		A4.COURSESOURCE AS 'stuCourseSourceId',A6.SOURCENAME AS 'stuCourseSourceName', A6.SOURCECHAR AS 'stuCourseSourceChar',
		A4.COURSETYPE AS 'stuCourseTypeId',A7.TYPENAME AS 'stuCourseTypeName', A7.TYPECHAR AS 'stuCourseTypeChar', 
		A5.MAJORNAME AS 'majorName' 
		FROM USERTABLE A1,CLASSTABLE A2,USERTABLE A3,COURSETABLE A4,MAJORTABLE A5,
		COURSESOURCE A6,COURSETYPE A7 
		WHERE A1.ISDELETED =0
		AND A1.STUCLASSID = A2.CLASSID AND A1.STUTEACHERID=A3.USERID 
		AND A1.STUCOURSEID = A4.COURSE_ID AND A1.STUTEACHERID=#{id} AND A2.INMAJOR=A5.MAJORID
		AND A4.ISDELETED=0 AND A4.COURSESOURCE=A6.ID AND A4.COURSETYPE=A7.ID ORDER BY A1.STUNUMBER
	</select>
	<select id="getStudentsCountByTeacherId" resultType="int" parameterType="int">
		SELECT COUNT(*) FROM USERTABLE WHERE ISDELETED=0 AND STUTEACHERID=#{id}
	</select>
	<select id="getAllTeachers" resultType="User">
		SELECT USERID,USERNAME,PASSWORD,PHONE,EMAIL,ROLE,
		REGTIME,REGIP,LASTLOGINTIME,LASTLOGINIP,TEAPOSITION,
		TEADESCRIPTION,TEAMAXSTU,TEACURRENTSTU,
		ISDELETED FROM USERTABLE  WHERE ISDELETED=0 AND 
		ROLE=2
	</select>
	<delete id="initialSystemDeleteStudents">
		delete from usertable where userid>0 and role=3;	
	</delete>
	<delete id="initialSystemDeleteTeachers">
		delete from usertable where userid>0 and role=2;	
	</delete>
</mapper>